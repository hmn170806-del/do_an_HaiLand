<?php 
session_start(); // QUAN TRỌNG: Phải start session
require "db.php"; 

// Kiểm tra đăng nhập. Nếu chưa thì đá về login
if (!isset($_SESSION['user_id'])) {
    echo "<script>alert('Vui lòng đăng nhập để đăng tin!'); window.location='login.php';</script>";
    exit();
}

$message = ""; 

if (isset($_POST['submit'])) {
    $name = mysqli_real_escape_string($conn, $_POST['name']);
    $price = intval($_POST['price']);
    $description = mysqli_real_escape_string($conn, $_POST['description']);
    $category = mysqli_real_escape_string($conn, $_POST['category']);
    $province = mysqli_real_escape_string($conn, $_POST['province']);
    
    // LẤY ID TỪ SESSION (Thay vì = 1 như cũ)
    $user_id = $_SESSION['user_id']; 

    // ... (Đoạn xử lý ảnh giữ nguyên như code của bạn) ...
    $upload_dir = "uploads/";
    $uploaded_images = [];
    
    if (!is_dir($upload_dir)) { mkdir($upload_dir, 0777, true); }

    if (!empty($_FILES['images']['name'][0])) {
        foreach ($_FILES['images']['name'] as $key => $val) {
            $file_name = $_FILES['images']['name'][$key];
            $file_tmp = $_FILES['images']['tmp_name'][$key];
            $file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
            $allowed_ext = ['jpg', 'jpeg', 'png', 'webp'];

            if (in_array($file_ext, $allowed_ext)) {
                $new_image_name = time() . "_" . uniqid() . "." . $file_ext;
                if (move_uploaded_file($file_tmp, $upload_dir . $new_image_name)) {
                    $uploaded_images[] = $new_image_name;
                }
            }
        }
    }

    if (count($uploaded_images) > 0) {
        $image_string = implode(',', $uploaded_images);
        $sql = "INSERT INTO products (name, price, description, category, province, image, user_id) 
                VALUES ('$name', $price, '$description', '$category', '$province', '$image_string', $user_id)";

        if (mysqli_query($conn, $sql)) {
            // Đăng xong chuyển về trang cá nhân
            echo "<script>alert('Đăng tin thành công!'); window.location='profile.php';</script>";
        } else {
            $message = "<div class='error-msg'>Lỗi DB: " . mysqli_error($conn) . "</div>";
        }
    } else {
        $message = "<div class='error-msg'>Vui lòng chọn ảnh hợp lệ!</div>";
    }
}
?>
<!DOCTYPE html>
<html lang="vi">
<head>
    <title>Đăng tin mới</title>
    <link rel="stylesheet" href="style.css">
    </head>
<body style="background: #f4f7f6;">
    <div class="container" style="margin-top:20px;">
        <a href="profile.php" style="text-decoration:none;">&larr; Quay lại trang cá nhân</a>
        <h2 style="text-align: center; color: #1e3a8a;">ĐĂNG TIN RAO BÁN</h2>
        <?= $message ?>
        <form method="POST" enctype="multipart/form-data" class="custom-form">
            <div class="form-group">
                <label>Tên sản phẩm</label>
                <input type="text" name="name" required style="width: 100%; padding: 12px; margin-top: 8px;">
            </div>
            <div class="form-group">
                <label>Giá bán</label>
                <input type="number" name="price" required style="width: 100%; padding: 12px; margin-top: 8px;">
            </div>
             <div class="form-group">
                <label>Danh mục</label>
                 <select name="category" required style="width: 100%; padding: 12px; margin-top: 8px;">
                    <option value="Dien thoai">Điện thoại</option>
                    <option value="Laptop">Laptop</option>
                    </select>
            </div>
            <div class="form-group">
                <label>Khu vực</label>
                <input type="text" name="province" required style="width: 100%; padding: 12px; margin-top: 8px;">
            </div>
            <div class="form-group">
                <label>Mô tả</label>
                <textarea name="description" rows="4" style="width: 100%; padding: 12px; margin-top: 8px;"></textarea>
            </div>
            <div class="form-group">
                 <label>Hình ảnh</label>
                 <input type="file" name="images[]" multiple required style="margin-top: 8px;">
            </div>
            <button type="submit" name="submit" style="width: 100%; padding: 15px; background: #1e3a8a; color: white; border: none; margin-top: 20px;">ĐĂNG TIN</button>
        </form>
    </div>
</body>
</html>
